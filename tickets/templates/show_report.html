{% extends 'show_base.html' %}
{% load show_tags %}
{% load staticfiles %}
{% block head %}
	<title>{% block title %}{{ show.name }} &middot; {% endblock %}</title>
{% endblock %}

{% block content %}
	<!-- Top Card -->
	<div class="container">
		<div class="row top-card">
			<div class="col s12">
				<div class="card small grey darken-3 top-card">
					<div class="row">
						<div class="col s4" id="poster-container">
							<div class="card-image show-poster hide-on-xs-only">
								<a href="/" rel="nofollow">
								{% if show.poster %}
									<img class="responsive-img" src="{{ show.poster.poster_page.url }}" id="report-image">
								{% else %}
									<img class="responsive-img" src="{% static 'images/no_image.png' %}" id="report-image">
								{% endif %}
								</a>
							</div>
						</div>
							<div class="card-content">
								<h1 class="light white-text flow-text xsmall-text center-on-xs-only truncate">
								{{ show.name }} 
								{% if report.have_form %} 
								on <strong>{{ report.day }}</strong> at <strong>{{ report.time }}</strong> 
								{% endif %}
								</h1>
								<div class="row hide-on-small-and-down">
									<div class="col s6">
										<button data-target="picker-modal" 
										class="btn nnt purple modal-trigger waves-effect waves-dark">
										<i class="material-icons left">payment</i>Choose Showing</button>
									</div>
									<div class="col s6">
										<a href="/report/{{ show.id }}">
											<button class="btn nnt purple waves-effect waves-dark">
											<i class="material-icons left">description</i>Sale Report</button>
										</a>
									</div>
								</div>
								<div class="row hide-on-med-and-up">
									<div class="col s6 xs6 center-align">
										<button data-target="picker-modal" 
										class="btn nnt purple modal-trigger waves-effect waves-dark">
										<i class="material-icons">payment</i></button>
									</div>
									<div class="col s6 xs6 center-align">
										<a href="/report/{{ show.id }}">
											<button class="btn nnt purple waves-effect waves-dark">
											<i class="material-icons">description</i></button>
										</a>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>

		{% if report.have_form %}
		<!-- Sale report overview -->
		<div class="row">
			<div class="col s12">
				<div class="card tiny grey darken-3">
					<div class="card-content" id="sale-update">
						{% ShowSaleOverview report %}
						<!-- See sale_overview.html -->
						<!-- and show_tags.py -->
					</div>
				</div>
			</div>
		</div>
		<!-- Sale input form -->
		<div class="row">
			{% if report.pricing_error %}
				<div class="col s12" id="form-background">
					<p class="light red-text center-align report-text pad-medium">
						Pricing for this show could not be retrieved from the database!
					</p>
				</div>
			{% else %}
			<form class="col s12" action="." method="post" id="sale-form">
			{% csrf_token %}
				<div class="row" id="form-background">
					<div class="input-field col s12">
					<!-- Hidden Unique Ticket ID -->
						<input name="{{ S_form.unique_ticket.name }}" 
									type="hidden"
									readonly="True" 
									value="{{ report.unique_ticket }}"
									id="unique_ticket">
					</div>
					<!-- Ticket Reservation -->
					<div class="input-field col s9" id="reservation_container">
						<input name="ticket" type="text" id="reservation" class="Validate" readonly="True" value="{{ report.reservation }}">
						<label for="ticket">Reservation</label>
					</div>

					<div class="col s3 center-align" id="form-button-inline">
						<button class="btn nnt purple waves-effect waves-dark modal-trigger" href="#modal2">Reservation</button>
					</div>

					<!-- Hidden inputs for ticket prices -->
					<div class="input-field col s12">	
						{% if pricing.concession_price %}
							<input type="hidden" value="{{ pricing.concession_price }}" id="concession_price">
						{% else %}
							<input type="hidden" value="0" id="concession_price">
						{% endif %}
						{% if pricing.member_price %}
							<input type="hidden" value="{{ pricing.member_price }}" id="member_price">
						{% else %}
							<input type="hidden" value="0" id="member_price">
						{% endif %}
						{% if pricing.public_price %}
							<input type="hidden" value="{{ pricing.public_price }}" id="public_price">
						{% else %}
							<input type="hidden" value="0" id="public_price">
						{% endif %}
						{% if report.season_price %}
							<input type="hidden" value="{{ report.season_price }}" id="season_price">
						{% else %}
							<input type="hidden" value="0" id="season_price">
						{% endif %}
						{% if pricing.fringe_price %}
							<input type="hidden" value="{{ pricing.fringe_price }}" id="fringe_price">
						{% else %}
							<input type="hidden" value="0" id="fringe_price">
						{% endif %}
						{% if pricing.matinee_freshers_price %}
							<input type="hidden" value="{{ pricing.matinee_freshers_price }}" id="matinee_freshers_price">
						{% else %}
							<input type="hidden" value="0" id="matinee_freshers_price">
						{% endif %}
						{% if pricing.matinee_freshers_nnt_price %}
							<input type="hidden" value="{{ pricing.matinee_freshers_nnt_price }}" id="matinee_freshers_nnt_price">
						{% else %}
							<input type="hidden" value="0" id="matinee_freshers_nnt_price">
						{% endif %}
					</div>
					{% if report.category.id == 1 %}
						<!-- Member Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_member.name }}" id="member" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_member.name }}">Member Tickets £{{ pricing.member_price }}</label>
						</div>

						<!-- Concession Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_concession.name }}" id="concession" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_concession.name }}">Concession Tickets £{{ pricing.concession_price }}</label>
						</div>

						<!-- Public Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_public.name }}" id="public" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_public.name }}">Public Tickets £{{ pricing.public_price }}</label>
						</div>

						<!-- Season Ticket Numbers -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_season.name }}" id="season" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_season.name }}">Season Pass Tickets</label>
						</div>

						<!-- Season Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_season_sales.name }}" id="season_sales" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_season_sales.name }}">Season Pass Ticket Sales £{{ report.season_price }}</label>
						</div>

						<!-- Fellow Ticket Numbers -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_fellow.name }}" id="fellow" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_fellow.name }}">Fellow Tickets</label>
						</div>
					{% if report.time|stringformat:"s" == report.default_time %}
						<div class="col s12">
							<!-- Hidden Fringe Ticket Sales -->
							<input name="{{ S_form.number_fringe.name }}" id="fringe" type="hidden" value="0">
							<!-- Hidden Matinee Fresher Ticket Sales -->
							<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="hidden" value="0">
							<!-- Hidden Matinee Fresher Member Ticket Sales -->
							<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="hidden" value="0">
						</div>
					{% elif report.time|stringformat:"s" == report.default_time_matinee %}
						<!-- Matinee Fresher Ticket Sales -->
						<div class="input-field col s6">
							<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_matinee_freshers.name }}">Matinee Fresher Tickets £{{ pricing.matinee_freshers_price }}</label>
						</div>

						<!-- Matinee Fresher Member Ticket Sales -->
						<div class="input-field col s6">
							<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_matinee_freshers_nnt.name }}">Matinee Member Fresher Tickets £{{ pricing.matinee_freshers_nnt_price }}</label>
						</div>

						<!-- Hidden Fringe Ticket Sales -->
						<div class="col s12">
							<input name="{{ S_form.number_fringe.name }}" id="fringe" type="hidden" value="0">
						</div>
					{% endif %}
					{% elif report.category.id == 2 %}
						<!-- Fringe Ticket Sales -->
						<div class="input-field col s3">
							<input name="{{ S_form.number_fringe.name }}" id="fringe" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_fringe.name }}">Fringe Tickets £{{ pricing.fringe_price }}</label>
						</div>

						<!-- Season Ticket Numbers -->
						<div class="input-field col s3">
							<input name="{{ S_form.number_season.name }}" id="season" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_season.name }}">Season Pass Tickets</label>
						</div>

						<!-- Season Ticket Sales -->
						<div class="input-field col s3">
							<input name="{{ S_form.number_season_sales.name }}" id="season_sales" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_season_sales.name }}">Season Pass Ticket Sales £{{ report.season_price }}</label>
						</div>

						<!-- Fellow Ticket Numbers -->
						<div class="input-field col s3">
							<input name="{{ S_form.number_fellow.name }}" id="fellow" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_fellow.name }}">Fellow Tickets</label>
						</div>

						<!-- Hidden Sale Inputs -->
						<div class="col s12">
							<input name="{{ S_form.number_concession.name }}" id="concession" type="hidden" value="0">
							<input name="{{ S_form.number_member.name }}" id="member" type="hidden" value="0">
							<input name="{{ S_form.number_public.name }}" id="public" type="hidden" value="0">
							<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="hidden" value="0">
							<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="hidden" value="0">
						</div>
					{% elif report.category.id == 3 %}
						<!-- Member Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_member.name }}" id="member" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_member.name }}">Member Tickets £{{ pricing.member_price }}</label>
						</div>

						<!-- Concession Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_concession.name }}" id="concession" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_concession.name }}">Concession Tickets £{{ pricing.concession_price }}</label>
						</div>

						<!-- Public Ticket Sales -->
						<div class="input-field col s4">
							<input name="{{ S_form.number_public.name }}" id="public" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
							<label for="{{ S_form.number_public.name }}">Public Tickets £{{ pricing.public_price }}</label>
						</div>

						<!-- Hidden Inputs -->
						<div class="col s12">
							<input name="{{ S_form.number_fringe.name }}" id="fringe" type="hidden" value="0">
						</div>

						{% if pricing.allow_season_tickets %}
							<!-- Season Ticket Numbers -->
							<div class="input-field col s4">
								<input name="{{ S_form.number_season.name }}" id="season" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
								<label for="{{ S_form.number_season.name }}">Season Pass Tickets</label>
							</div>

							<!-- Season Ticket Sales -->
							<div class="input-field col s4">
								<input name="{{ S_form.number_season_sales.name }}" id="season_sales" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
								<label for="{{ S_form.number_season_sales.name }}">Season Pass Ticket Sales £{{ report.season_price }}</label>
							</div>
						{% else %}

							<!-- Hidden Inputs -->
							<div class="col s12">
								<input name="{{ S_form.number_season.name }}" id="season" type="hidden" value="0">
								<input name="{{ S_form.number_season_sales.name }}" id="season_sales" type="hidden" value="0">
							</div>
						<!-- End allow_season_tickets -->
						{% endif %}
						{% if pricing.allow_fellow_tickets %}
							<!-- Fellow Ticket Numbers -->
							<div class="input-field col s4">
								<input name="{{ S_form.number_fellow.name }}" id="fellow" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
								<label for="{{ S_form.number_fellow.name }}">Fellow Tickets</label>
							</div>
						{% else %}
							<!-- Hidden Inputs -->
							<div class="col s12">
								<input name="{{ S_form.number_fellow.name }}" id="fellow" type="hidden" value="0">
							</div>
						<!-- End allow_fellow_tickets -->
						{% endif %}
						{% if report.time|stringformat:"s" == report.default_time_matinee %}
							{% if pricing.allow_half_matinee %}
								<!-- Matinee Fresher Ticket Sales -->
								<div class="input-field col s6">
									<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
									<label for="{{ S_form.number_matinee_freshers.name }}">Matinee Fresher Tickets £{{ report.matinee_freshers_price }}</label>
								</div>
							{% else %}
								<!-- Hidden Inputs -->
								<div class="col s12">
									<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="hidden" value="0">
								</div>
							<!-- End allow_half_matinee -->
							{% endif %}
							{% if pricing.allow_half_nnt_matinee %}
								<!-- Matinee Fresher Member Ticket Sales -->
								<div class="input-field col s6">
									<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="number" class="validate" value="0" max="{{ report.how_many_left }}" min="0" onclick="this.focus();this.select()">
									<label for="{{ S_form.number_matinee_freshers_nnt.name }}">Matinee Member Fresher Tickets £{{ report.matinee_freshers_nnt_price }}</label>
								</div>
							{% else %}
								<!--  -->
								<div class="col s12">
									<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="hidden" value="0">
								</div>
							{% endif %}
						{% else %}
							<div class="col s12">
								<input name="{{ S_form.number_matinee_freshers_nnt.name }}" id="matinee_freshers_nnt" type="hidden" value="0">
								<input name="{{ S_form.number_matinee_freshers.name }}" id="matinee_freshers" type="hidden" value="0">
							</div>
						{% endif %}

					{% else %}
						<div class="col s12">
							<p class="light red-text center-align report-text">Invalid category applied ({{ report.category }})</p>
							<br>
						</div>
					{% endif %}
				</div>
				<div class="row">
					<div class="col s12">
						<div class="card tiny grey darken-3 valign-wrapper">
							<div class="col s3 center-align">
								<span class="valign nnt-orange sale-text">Total sales: <span id="sale-final">{% ShowSales report %}</span></span>
							</div>
							<div class="col s3 center-align">
								<span class="nnt-orange sale-text">Order Total: <span class="bold">£</span><span class="bold" id="out"></span></span>
							</div>
							<div class="col s3 center-align">
								<button type="reset" class="btn nnt purple waves-effect waves-dark" onclick="resetButton()">Reset</button>
							</div>
							<div class="col s3 center-align"> 
							{% if report.how_many_left == 0 %}
								<button type="button" class="disabled btn nnt purple">Sell Tickets</button>
							{% else %}
								<button type="submit" class="btn nnt purple waves-effect waves-dark" onclick="resetButton()">Sell Tickets</button>
							{% endif %}
							</div>
						</div>
					</div>
				</div>
			</form>
			{% endif %}
		</div>
		{% else %}
			<div class="hidden">
				<form method="post" action="." id="sale_form"></form>
			</div>
		{% endif %}

		<!-- Occurrence Modal Structure -->
		<div id="picker-modal" class="modal bottom-sheet" style="display: block; overflow: scroll;">
			<div class="modal-content">
				<div class="row">
					<h4 class="truncate">{{ show.name }}</h4>
						{% for oc in occurrence %}
							<div class="col s12">
								<a href="/show/{{ show.id }}/{{ oc.0 }}" class="modal-action modal-close btn-flat">
								<span class="hide-on-xs-and-down">{{ show.name }} on</span><strong>{{ oc.2 }}</strong> at <strong>{{ oc.4 }}</strong>
								<span class="hide-on-small-and-down">
								{% if oc.5 == 1 %}
								, <strong>{{ oc.5 }}</strong> ticket reserved
								{% else %}
									, <strong>{{ oc.5 }}</strong> tickets reserved
								{% endif %}
								</span>
								</a>
							</div>
							<br>
							{% empty %}
								<div class="col s12">
								<span class="modal-action modal-close btn-flat">There are no showings available</span>
							</div>
							{% endfor %}
						</div>
				</div>
		</div>

		<!-- Reservation Modal Structure -->
		<div id="modal2" class="modal modal-fixed-footer grey darken-3">
			<div class="modal-content">
				<h4 class="nnt-text text-orange">Reservations for {{ show.name }}</h4>
					<div class="row">
						<div class="col s12" id="reservation_modal_container">
							{% ReservationModal report %}
							<!-- See sale_overview_full.html -->
							<!-- and reservation_modal.html -->
							<!-- and show_tags.py -->
						</div>
					</div>
			</div>
			<div class="modal-footer grey darken-2">
				<a class="modal-action modal-close waves-effect waves-purple btn-flat nnt-text text-orange">Close</a>
			</div>
		</div>

	</div>
	
{% endblock %}
{% block footer %}
	<!-- Set up modal trigger and sale tally -->
	<script>
		$(document).ready(function(){
			xff = parseFloat(0).toFixed(2)
			document.getElementById("out").innerHTML = xff;
		});
	</script>

	<!-- Dynamic addition of sales -->
	<script>
	$(document).ready(function(){
		$('input').keyup(function(){
			var concession_price = document.getElementById("concession_price").value;
			var member_price = document.getElementById("member_price").value;
			var public_price = document.getElementById("public_price").value;
			var fringe_price = document.getElementById("fringe_price").value;
			var matinee_freshers_price = document.getElementById("matinee_freshers_price").value;
			var matinee_freshers_nnt_price = document.getElementById("matinee_freshers_nnt_price").value;
			var season_price = document.getElementById("season_price").value;

			var num_concession = document.getElementById("concession").value * concession_price;
			var num_member = document.getElementById("member").value * member_price;
			var num_public = document.getElementById("public").value * public_price;
			var num_fringe = document.getElementById("fringe").value * fringe_price;
			var num_matinee_freshers = document.getElementById("matinee_freshers").value * matinee_freshers_price;
			var num_matinee_freshers_nnt = document.getElementById("matinee_freshers_nnt").value * matinee_freshers_nnt_price;
			var num_season = document.getElementById("season").value * 0;
			var num_fellow = document.getElementById("fellow").value * 0;
			var num_season_sale = document.getElementById("season_sales").value * season_price;

			var x = 
				+num_concession +
				+num_member +
				+num_public +
				+num_fringe +
				+num_matinee_freshers +
				+num_matinee_freshers_nnt +
				+num_season +
				+num_fellow +
				+num_season_sale;
				
			xf = parseFloat(x).toFixed(2);
			document.getElementById("out").innerHTML = xf;
		});
	});
	</script>

	<!-- Submit post on form submit -->
	<script>
		$('#sale-form').on('submit', function(event){
			event.preventDefault();
			// console.log("Sell form submitted")  // sanity check
			sell_tickets();
			return false;
		});
	</script>

	<script>
	  $(document).on('submit', '.reserve-form', function(event){
			var id = $(this).attr('id');
			event.preventDefault();
			// console.log(id);
			// console.log("Collect form submitted");  // sanity check
			collect_tickets(id);
			$('#modal2').closeModal();
			return false;
		});
	</script>

	<!-- Reset sale tally on reset -->
	<script>
	function resetButton() {
		xr = parseFloat(0).toFixed(2);
		document.getElementById("out").innerHTML = xr;
		// document.getElementById("reservation").innerHTML = "None";
	}
	</script>

	<script src="{% static 'js/main.js' %}"></script>
{% endblock %}
